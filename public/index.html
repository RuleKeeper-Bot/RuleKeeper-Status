<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RuleKeeper Status</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <link href="favicon.ico" rel="icon" type="image/x-icon">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --online-color: #22c55e;
      --offline-color: #ef4444;
      --bg-color: #f9fafb;
      --card-bg: #ffffff;
      --text-color: #1f2937;
      --subtext-color: #6b7280;
      --shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    body {
      margin: 0;
      padding: 2rem;
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .card {
      background-color: var(--card-bg);
      padding: 2rem 3rem;
      border-radius: 1.5rem;
      box-shadow: var(--shadow);
      text-align: center;
      max-width: 500px;
      width: 100%;
    }

    .status-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .status-icon.online {
      color: var(--online-color);
    }

    .status-icon.offline {
      color: var(--offline-color);
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .status-text {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
    }

    .info {
      font-size: 1rem;
      color: var(--subtext-color);
      margin-top: 0.25rem;
    }

    canvas {
      margin-top: 1.5rem;
    }
  </style>
</head>
<body>
  <div class="card">
    <div id="icon" class="status-icon">‚è≥</div>
    <h1>RuleKeeper Status</h1>
    <div id="status" class="status-text">Loading...</div>
    <div id="timer" class="info"></div>
    <div id="extra" class="info"></div>
    <canvas id="uptimeChart" width="400" height="200"></canvas>
    <div id="uptimeText" class="info"></div>
  </div>

  <script>
    function formatDuration(ms) {
      if (ms < 0) ms = 0;
      const s = Math.floor(ms / 1000);
      const w = Math.floor(s / (7 * 86400));
      const d = Math.floor((s % (7 * 86400)) / 86400);
      const h = Math.floor((s % 86400) / 3600);
      const m = Math.floor((s % 3600) / 60);
      const sec = s % 60;
      return `${w}w ${d}d ${h}h ${m}m ${sec}s`;
    }
    
    function formatMinutesSeconds(ms) {
      if (ms < 0) ms = 0;
      const s = Math.floor(ms / 1000);
      const m = Math.floor(s / 60);
      const sec = s % 60;
      return `${m}m ${sec}s`;
    }

    function formatSmartDuration(seconds) {
      let s = Math.floor(seconds);
      if (s < 0) return "0 seconds";
      const parts = [];

      const units = [
        { label: "month", seconds: 2629800 },
        { label: "week", seconds: 604800 },
        { label: "day", seconds: 86400 },
        { label: "hour", seconds: 3600 },
        { label: "minute", seconds: 60 },
        { label: "second", seconds: 1 },
      ];

      for (const unit of units) {
        const amt = Math.floor(s / unit.seconds);
        if (amt > 0) {
          parts.push(`${amt} ${unit.label}${amt !== 1 ? "s" : ""}`);
          s %= unit.seconds;
        }
      }

      if (parts.length === 0) return "0 seconds";

      return parts.join(", ");
    }

    let state = {
      isOnline: null,
      downStartTime: null,
      lastOnlineTime: null,
      nextCheck: null,
      now: null
    };

    let uptimeRefreshInterval = null;

    function updateDisplay() {
      const now = new Date();
      const icon = document.getElementById("icon");
      const statusText = document.getElementById("status");
      const timer = document.getElementById("timer");
      const extra = document.getElementById("extra");

      const timeUntilNext = new Date(state.nextCheck) - now;
      timer.textContent = `Next scan in: ${formatMinutesSeconds(timeUntilNext)}`;

      if (state.isOnline) {
        icon.textContent = "‚úÖ";
        icon.className = "status-icon online";
        statusText.textContent = "Online";

        if (state.lastOnlineTime) {
          const recoveredAt = new Date(state.lastOnlineTime);
          extra.textContent = `Last downtime ended ${formatDuration(now - recoveredAt)} ago`;
        } else if (state.downStartTime) {
          // This means the server is online but there was a downtime in the past
          extra.textContent = "Downtime has been recorded.";
        } else {
          // Never been down
          extra.textContent = "No downtime recorded.";
        }
      } else {
        icon.textContent = "üõ†Ô∏è";
        icon.className = "status-icon offline";
        statusText.textContent = "Under Maintenance";

        if (state.downStartTime) {
          const downSince = new Date(state.downStartTime);
          extra.textContent = `Under maintenance for ${formatDuration(now - downSince)}`;
        } else {
          extra.textContent = "Duration unknown.";
        }
      }
    }

    async function loadStatus() {
      const res = await fetch("/status");
      const data = await res.json();

      state = {
        isOnline: data.isOnline,
        downStartTime: data.downStartTime,
        lastOnlineTime: data.lastOnlineTime,
        nextCheck: data.nextCheck,
        now: new Date(data.now)
      };

      updateDisplay();
    }

    async function loadUptime() {
      const res = await fetch("/uptime");
      const data = await res.json();

      const chartCanvas = document.getElementById('uptimeChart').getContext('2d');
      const existingChart = Chart.getChart(chartCanvas);
      if (existingChart) existingChart.destroy();

      new Chart(chartCanvas, {
        type: 'doughnut',
        data: {
          labels: ['Uptime', 'Maintenance'],
          datasets: [{
            data: [data.uptimeSeconds, data.downtimeSeconds],
            backgroundColor: ['#22c55e', '#ef4444'],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: function (ctx) {
                  const label = ctx.label || "";
                  const value = ctx.raw || 0;
                  const duration = formatSmartDuration(value);
                  return `${label}: ${duration}`;
                }
              }
            }
          }
        }
      });

      document.getElementById('uptimeText').textContent = 
		`Total Uptime: ${data.uptimePercentageExact}% (exact)`;


      // Schedule next refresh based on server timing
      if (uptimeRefreshInterval) clearInterval(uptimeRefreshInterval);
      
      const now = new Date();
      const nextRefresh = new Date(data.nextRefresh);
      const delay = nextRefresh - now;
      
      setTimeout(() => {
        loadUptime(); // Immediate refresh at the aligned time
        uptimeRefreshInterval = setInterval(loadUptime, 60000); // Then regular 60s interval
      }, delay);
    }

    // Initial load
    loadStatus();
    loadUptime();
    setInterval(loadStatus, 60000);
    setInterval(updateDisplay, 1000);
  </script>
</body>
</html>